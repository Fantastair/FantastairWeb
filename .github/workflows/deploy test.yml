# 除了最终没有部署到 VPS 之外，所有操作和主分支相同
name: DeployTest
on:
  push:
    branches: [deploy]
  workflow_dispatch:

env:
  # 开关： true=任何警告也整流失败  false=仅真正错误才失败
  FAIL_ON_WARNING: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- 基础 ----------
      - name: 1. Checkout
        uses: actions/checkout@v4

      # ---------- 缓存 + 装依赖 ----------
      - name: 2.1 Cache global npm & npx
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/npm
            ~/.cache/_npx
          key: ${{ runner.os }}-npm-global-${{ hashFiles('./deploy_version') }}
          restore-keys: ${{ runner.os }}-npm-global-

      - name: 2.2 Install system依赖
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-pip brotli zopfli parallel
          pip3 install --user fonttools

      - name: 2.3 Install npm CLI
        run: |
          npm i -g --loglevel=error \
            html-minifier-terser@7 \
            csso-cli@4 \
            terser@5 \
            glyphhanger@5

      # ---------- 初始化警告计数器 ----------
      - name: 3. Init warning tracker
        run: |
          echo "WARN_COUNT=0" >> $GITHUB_ENV
          echo "WARN_MSG="   >> $GITHUB_ENV

      # ---------- 并行裁剪 HTML ----------
      - name: 4. Minify HTML
        run: |
          find . -name '*.html' -print0 |
            parallel -0 -j$(nproc) --bar \
              'html-minifier-terser {} --collapse-whitespace --remove-comments \
               --minify-js --minify-css -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 CSS ----------
      - name: 5. Minify CSS
        run: |
          find . -name '*.css' -print0 |
            parallel -0 -j$(nproc) --bar \
              'csso {} -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 JS ----------
      - name: 6. Minify JS
        run: |
          find . -name '*.js' -print0 |
            parallel -0 -j$(nproc) --bar \
              'terser {} -c -m --ecma 2018 --module -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 JSON ----------
      - name: 7. Minify JSON
        run: |
          find . -name '*.json' -print0 |
            parallel -0 -j$(nproc) --bar \
              'jq -c . {} > {.}.tmp && mv {.}.tmp {}'

      # ---------- 手动指定字符集 子集化 Font-Awesome ----------
      - name: 8. Subset Fonts
        run: |
          for fontpath in fa-regular-400 fa-brands-400 fa-solid-900; do
            fontfile="./assets/fonts/${fontpath}.woff2"
            listfile="./assets/fonts/${fontpath}.woff2.txt"
            # 如果白名单不存在就跳过，避免 0 字字体
            [[ -f "$listfile" ]] || { echo "⚠️ $listfile 不存在，跳过子集化"; continue; }
            [[ -f "$fontfile" ]] || { echo "⚠️ $fontfile 不存在，跳过";        continue; }

            glyphhanger \
              --subset="$fontfile" \
              --unicodes-file="$listfile" \
              --formats=woff2 \
              --output="${fontfile%.woff2}.subset.woff2"

            if [[ -s "${fontfile%.woff2}.subset.woff2" ]]; then
              mv "${fontfile%.woff2}.subset.woff2" "$fontfile"
              echo "✔ ${fontpath} 子集化完成"
            else
              echo "::warning::${fontpath} 子集化失败或白名单为空"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>Font Awesome ${fontpath} subset failed</li>" >> $GITHUB_ENV
            fi
          done

      # ---------- 高压缩（gzip + brotli + zopfli）原地 ----------
      - name: 9. Pre-compress static assets
        run: |
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.svg" \
            -o -name "*.json" -o -name "*.html" -o -name "*.woff2" \) \
            -exec sh -c 'zopfli -i999 {} && brotli -q 11 -f {}' \;

      # ---------- 最终汇总 ----------
      - name: 10. Summary & decide exit code
        run: |
          {
            echo "### Build Summary"
            if [[ $WARN_COUNT -eq 0 ]]; then
              echo "✅ 无警告，全部成功"
            else
              echo "⚠️ 出现 <b>$WARN_COUNT</b> 个警告："
              echo "<ul>${WARN_MSG}</ul>"
            fi
          } >> $GITHUB_STEP_SUMMARY

          if [[ "$FAIL_ON_WARNING" == "true" && $WARN_COUNT -gt 0 ]]; then
            echo "::error::因 FAIL_ON_WARNING=true，整流失败"
            exit 1
          fi