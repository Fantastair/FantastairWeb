# 除了最终没有部署到 VPS 之外，所有操作和主分支相同
name: DeployTest
on:
  push:
    branches: [deploy]
  workflow_dispatch:

env:
  # 开关： true=任何警告也整流失败  false=仅真正错误才失败
  FAIL_ON_WARNING: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- 基础 ----------
      - name: 1. Checkout
        uses: actions/checkout@v4

      # ---------- 缓存 + 装依赖 ----------
      - name: 2.1 Cache global npm & npx
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/npm
            ~/.cache/_npx
          key: ${{ runner.os }}-npm-global-${{ hashFiles('./deploy_version') }}
          restore-keys: ${{ runner.os }}-npm-global-

      - name: 2.2 Install dependencies
        run: |
          npm i -g --loglevel=error \
            html-minifier-terser csso-cli terser \
            glyphhanger glyphhanger-font-awesome \
            parallel brotli zopfli

      # ---------- 初始化警告计数器 ----------
      - name: 3. Init warning tracker
        run: |
          echo "WARN_COUNT=0" >> $GITHUB_ENV
          echo "WARN_MSG="   >> $GITHUB_ENV

      # ---------- 并行裁剪 HTML ----------
      - name: 4. Minify HTML
        run: |
          find . -name '*.html' -print0 |
            parallel -0 -j$(nproc) --bar \
              'html-minifier-terser {} --collapse-whitespace --remove-comments \
               --minify-js --minify-css -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 CSS ----------
      - name: 5. Minify CSS
        run: |
          find . -name '*.css' -print0 |
            parallel -0 -j$(nproc) --bar \
              'csso {} -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 JS ----------
      - name: 6. Minify JS
        run: |
          find . -name '*.js' -print0 |
            parallel -0 -j$(nproc) --bar \
              'terser {} -c -m --ecma 2018 --module -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 JSON ----------
      - name: 7. Minify JSON
        run: |
          find . -name '*.json' -print0 |
            parallel -0 -j$(nproc) --bar \
              'jq -c . {} > {.}.tmp && mv {.}.tmp {}'

      # ---------- 一键子集化 Font-Awesome（原地替换） ----------
      - name: 8. Subset FontAwesome fonts
        run: |
          for weight in regular brands solid; do
            srcfont="./assets/fonts/fa-${weight}-400.woff2"
            [[ $weight == solid ]] && srcfont="./assets/fonts/fa-${weight}-900.woff2"
            [[ ! -f $srcfont ]] && continue   # 字体不存在则跳过

            npx glyphhanger-font-awesome \
              --src=. \
              --weight=$weight \
              --font="$srcfont" \
              --output="${srcfont%.woff2}.subset.woff2"

            if [[ -s "${srcfont%.woff2}.subset.woff2" ]]; then
              mv "${srcfont%.woff2}.subset.woff2" "$srcfont"
              echo "✔ fa-${weight} 子集化完成"
            else
              echo "::warning::fa-${weight} 子集化失败或没有用到任何图标"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>Font Awesome ${weight} subset failed</li>" >> $GITHUB_ENV
            fi
          done

      # ---------- 高压缩（gzip + brotli + zopfli）原地 ----------
      - name: 9. Pre-compress static assets
        run: |
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.svg" \
            -o -name "*.json" -o -name "*.html" -o -name "*.woff2" \) \
            -exec sh -c 'zopfli -i999 {} && brotli -q 11 -f {}' \;

      # ---------- 最终汇总 ----------
      - name: 10. Summary & decide exit code
        run: |
          {
            echo "### Build Summary"
            if [[ $WARN_COUNT -eq 0 ]]; then
              echo "✅ 无警告，全部成功"
            else
              echo "⚠️ 出现 <b>$WARN_COUNT</b> 个警告："
              echo "<ul>${WARN_MSG}</ul>"
            fi
          } >> $GITHUB_STEP_SUMMARY

          if [[ "$FAIL_ON_WARNING" == "true" && $WARN_COUNT -gt 0 ]]; then
            echo "::error::因 FAIL_ON_WARNING=true，整流失败"
            exit 1
          fi