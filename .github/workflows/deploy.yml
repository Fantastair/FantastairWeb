name: Deploy
on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  # 开关： true=任何警告也整流失败  false=仅真正错误才失败
  FAIL_ON_WARNING: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- 基础 ----------
      - name: 1. Checkout
        uses: actions/checkout@v4

      # ---------- 安装依赖 ----------
      - name: 2. Install dependencies
        run: |
          npm install -g html-minifier-terser csso-cli terser glyphhanger glyphhanger-fontawesome
          sudo apt-get update && sudo apt-get install -y python3-fonttools jq

      # ---------- 初始化警告计数器 ----------
      - name: 3. Init warning tracker
        run: |
          echo "WARN_COUNT=0" >> $GITHUB_ENV
          echo "WARN_MSG=" >> $GITHUB_ENV

      # ---------- 裁剪 HTML ----------
      - name: 4. Minify HTML
        run: |
          while IFS= read -r -d '' file; do
            if ! html-minifier-terser "$file" \
                 --collapse-whitespace \
                 --remove-comments \
                 --minify-js \
                 --minify-css \
                 -o "$file.tmp"; then
              echo "::warning::HTML minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>HTML: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.html" -type f -print0)

      # ---------- 裁剪 CSS ----------
      - name: 5. Minify CSS
        run: |
          while IFS= read -r -d '' file; do
            if ! csso "$file" --output "$file.tmp"; then
              echo "::warning::CSS minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>CSS: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.css" -type f -print0)

      # ---------- 裁剪 JS ----------
      - name: 6. Minify JS
        run: |
          while IFS= read -r -d '' file; do
            if ! terser "$file" -c -m --ecma 2018 --module -o "$file.tmp"; then
              echo "::warning::JS minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>JS: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.js" -type f -print0)

      # ---------- 裁剪 JSON ----------
      - name: 7. Minify JSON
        run: |
          while IFS= read -r -d '' file; do
            if ! jq -c . "$file" > "$file.tmp"; then
              echo "::warning::JSON minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>JSON: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.json" -type f -print0)

      # ---------- 生成 Unicode 子集 ----------
      - name: 8. Generate unicode subset
        run: |
          glyphhanger \
            --subset=*.html,*.js,*.css \
            --formats=woff2 \
            --fontawesome=./src/styles/fontawesome \
            --output=./glyphhanger-chars.txt
          # 如果仍为空则报警
          if [[ ! -s ./glyphhanger-chars.txt ]]; then
            echo "::warning::字符集为空，字体将被裁成 0 字"
            echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
            echo "WARN_MSG=${WARN_MSG}<li>Glyphhanger: 未提取到任何字符</li>" >> $GITHUB_ENV
          fi

      # ---------- 子集化字体 ----------
      - name: 9. Subset fonts
        run: |
          for font in ./assets/fonts/fa-regular-400.woff2 \
                      ./assets/fonts/fa-brands-400.woff2 \
                      ./assets/fonts/fa-solid-900.woff2; do
            if [[ ! -f $font ]]; then
              echo "::warning::字体文件不存在: $font"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>Font missing: $font</li>" >> $GITHUB_ENV
              continue
            fi
            if ! python3 -m fontTools.subset "$font" \
                 --unicodes-file=./glyphhanger-chars.txt \
                 --flavor=woff2 \
                 --output-file="${font%.woff2}.subset.woff2"; then
              echo "::warning::字体子集化失败: $font"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>Font subset: $font</li>" >> $GITHUB_ENV
              continue
            fi
            mv "${font%.woff2}.subset.woff2" "$font"
          done

      # ---------- 预压缩 ----------
      - name: 10. Pre-compress static assets
        run: |
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.svg" -o -name "*.json" -o -name "*.html" -o -name "*.woff2" \) \
            -exec gzip -k -9 {} \;

      # ---------- 最终汇总 ----------
      - name: 11. Summary & decide exit code
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          if [[ $WARN_COUNT -eq 0 ]]; then
            echo "✅ 无警告，全部成功" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ 出现 <b>$WARN_COUNT</b> 个警告：" >> $GITHUB_STEP_SUMMARY
            echo "<ul>${WARN_MSG}</ul>" >> $GITHUB_STEP_SUMMARY
            if [[ "$FAIL_ON_WARNING" == "true" ]]; then
              echo "::error::因 FAIL_ON_WARNING=true，整流失败"
              exit 1
            fi
          fi

      # ---------- 部署 ----------
      - name: 12. Deploy to VPS
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rlvz --delete --exclude='.git*' --exclude='.user.ini' --chmod=Dg+rwx,Fg+rw
          path: ./
          remote_path: ${{ secrets.VPS_TARGET_DIR }}
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}