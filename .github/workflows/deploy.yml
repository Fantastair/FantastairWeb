name: Deploy
on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  # 开关： true=任何警告也整流失败  false=仅真正错误才失败
  FAIL_ON_WARNING: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- 基础 ----------
      - name: 1. Checkout
        uses: actions/checkout@v4

      # ---------- 缓存 + 装依赖 ----------
      - name: 2.1 Cache global npm & npx
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            ~/.cache/npm
            ~/.cache/_npx
          key: ${{ runner.os }}-npm-global-${{ hashFiles('./deploy_version') }}
          restore-keys: ${{ runner.os }}-npm-global-

      - name: 2.2 Install system依赖
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y python3-pip zopfli parallel
          pip3 install --user fonttools brotli

      - name: 2.3 Install npm CLI
        run: |
          npm i -g --loglevel=error \
            html-minifier-terser@7 \
            csso-cli@4 \
            terser@5

      # ---------- 初始化警告计数器 ----------
      - name: 3. Init warning tracker
        run: |
          echo "WARN_COUNT=0" >> $GITHUB_ENV
          echo "WARN_MSG="   >> $GITHUB_ENV

      # ---------- 并行裁剪 HTML ----------
      - name: 4. Minify HTML
        run: |
          find . -name '*.html' -print0 |
            parallel -0 -j$(nproc) --bar \
              'html-minifier-terser {} --collapse-whitespace --remove-comments \
               --minify-js --minify-css -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 CSS ----------
      - name: 5. Minify CSS
        run: |
          find . -name '*.css' -print0 |
            parallel -0 -j$(nproc) --bar \
              'csso {} -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 JS ----------
      - name: 6. Minify JS
        run: |
          find . -name '*.js' -print0 |
            parallel -0 -j$(nproc) --bar \
              'terser {} -c -m --ecma 2018 --module -o {.}.tmp && mv {.}.tmp {}'

      # ---------- 并行裁剪 JSON ----------
      - name: 7. Minify JSON
        run: |
          find . -name '*.json' -print0 |
            parallel -0 -j$(nproc) --bar \
              'jq -c . {} > {.}.tmp && mv {.}.tmp {}'

      # ---------- 手动指定字符集 子集化 ----------
      - name: 8. Subset Fonts
        run: |
          python3 - << 'EOF'
          from fontTools.ttLib import TTFont
          from fontTools.subset import Subsetter
          from pathlib import Path
          import sys, os

          repo = Path.cwd()
          for weight in ('regular','brands','solid'):
              fontfile   = repo / f'assets/fonts/fa-{weight}-400.woff2'
              if weight=='solid': fontfile = repo / 'assets/fonts/fa-solid-900.woff2'
              listfile   = fontfile.with_suffix('.woff2.txt')
              if not listfile.exists(): continue

              font = TTFont(fontfile)
              with listfile.open() as f:
                  unicodes = [int(x,16) for x in f.read().split()]
              print(f'{weight} 白名单数量: {len(unicodes)}')

              sub = Subsetter()
              sub.populate(unicodes=unicodes)
              sub.subset(font)

              out = fontfile.with_name(f'{fontfile.stem}-subset.woff2')
              font.save(out)
              os.replace(out, fontfile)
              print(f'{weight} 子集化完成  {fontfile.stat().st_size} bytes')
          EOF

      # ---------- 高压缩（zopfli） ----------
      - name: 9. Pre-compress static assets
        run: |
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.svg" \
            -o -name "*.json" -o -name "*.html" -o -name "*.woff2" \) \
            -exec sh -c 'zopfli -i999 {}' \;

      # ---------- 最终汇总 ----------
      - name: 10. Summary & decide exit code
        run: |
          {
            echo "### Build Summary"
            if [[ $WARN_COUNT -eq 0 ]]; then
              echo "✅ 无警告，全部成功"
            else
              echo "⚠️ 出现 <b>$WARN_COUNT</b> 个警告："
              echo "<ul>${WARN_MSG}</ul>"
            fi
          } >> $GITHUB_STEP_SUMMARY

          if [[ "$FAIL_ON_WARNING" == "true" && $WARN_COUNT -gt 0 ]]; then
            echo "::error::因 FAIL_ON_WARNING=true，整流失败"
            exit 1
          fi

      # ---------- 部署 ----------
      - name: 11. Deploy to VPS
        uses: burnett01/rsync-deployments@6.0.0
        with:
          switches: -rlvz --delete --exclude='.git*' --exclude='.user.ini' --chmod=Dg+rwx,Fg+rw
          path: ./
          remote_path: ${{ secrets.VPS_TARGET_DIR }}
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}