name: Deploy
on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  # 开关： true=任何警告也整流失败  false=仅真正错误才失败
  FAIL_ON_WARNING: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- 基础 ----------
      - name: 1. Checkout
        uses: actions/checkout@v4

      # ---------- 缓存 & 安装 ----------
      - name: 2. Cache minifier
        id: cache-minifier
        uses: actions/cache@v4
        with:
          path: ~/tools/minifier
          key: minifier-${{ runner.os }}-${{ hashFiles('minifier-version') }}

      - name: 3. Cache glyphhanger
        id: cache-glyphhanger
        uses: actions/cache@v4
        with:
          path: |
            ~/tools/glyphhanger
            /usr/local/lib/python3*/site-packages/fontTools
          key: glyphhanger-${{ runner.os }}-${{ hashFiles('glyphhanger-version') }}

      - name: 4. Install minifier
        if: steps.cache-minifier.outputs.cache-hit != 'true'
        run: |
          npm install --prefix ~/tools/minifier html-minifier-terser csso-cli terser@latest

      - name: 5. Install glyphhanger
        if: steps.cache-glyphhanger.outputs.cache-hit != 'true'
        run: |
          npm install --prefix ~/tools/glyphhanger -g glyphhanger
          sudo apt-get update && sudo apt-get install -y python3-fonttools

      - name: 6. Add tools to PATH
        run: |
          echo "$HOME/tools/minifier/bin" >> $GITHUB_PATH
          echo "$HOME/tools/glyphhanger/bin" >> $GITHUB_PATH
          sudo ln -sf /usr/bin/pyftsubset /usr/local/bin/pyftsubset

      - name: 7. Install glyphhanger
        if: steps.cache-glyphhanger.outputs.cache-hit != 'true'
        run: |
          npm install --prefix ~/tools/glyphhanger -g glyphhanger
          sudo apt-get update && sudo apt-get install -y python3-fonttools
          echo '~/tools/glyphhanger/bin' >> $GITHUB_PATH

      # ---------- 初始化警告计数器 ----------
      - name: 8. Init warning tracker
        run: |
          echo "WARN_COUNT=0" >> $GITHUB_ENV
          echo "WARN_MSG=" >> $GITHUB_ENV

      # ---------- 裁剪 HTML ----------
      - name: 9. Minify HTML
        run: |
          while IFS= read -r -d '' file; do
            if ! html-minifier-terser "$file" \
                 --collapse-whitespace \
                 --remove-comments \
                 --minify-js \
                 --minify-css \
                 -o "$file.tmp"; then
              echo "::warning::HTML minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>HTML: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.html" -type f -print0)

      # ---------- 裁剪 CSS ----------
      - name: 10. Minify CSS
        run: |
          while IFS= read -r -d '' file; do
            if ! csso "$file" --output "$file.tmp"; then
              echo "::warning::CSS minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>CSS: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.css" -type f -print0)

      # ---------- 裁剪 JS ----------
      - name: 11. Minify JS
        run: |
          while IFS= read -r -d '' file; do
            if ! terser "$file" -c -m --ecma 2018 --module -o "$file.tmp"; then
              echo "::warning::JS minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>JS: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.js" -type f -print0)

      # ---------- 裁剪 JSON ----------
      - name: 12. Minify JSON
        run: |
          while IFS= read -r -d '' file; do
            if ! jq -c . "$file" > "$file.tmp"; then
              echo "::warning::JSON minify failed: $file"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>JSON: $file</li>" >> $GITHUB_ENV
              continue
            fi
            mv "$file.tmp" "$file"
          done < <(find . -name "*.json" -type f -print0)

      # ---------- 生成 Unicode 子集 ----------
      - name: 13. Generate unicode subset
        run: |
          if ! glyphhanger \
               --subset=*.html,*.js,*.css \
               --formats=woff2 \
               --output=./glyphhanger-chars.txt; then
            echo "::error::glyphhanger 扫描失败，终止流程"
            exit 1
          fi
          # 如果字符集为空也报警
          if [[ ! -s ./glyphhanger-chars.txt ]]; then
            echo "::warning::字符集为空，字体将被裁成 0 字"
            echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
            echo "WARN_MSG=${WARN_MSG}<li>Glyphhanger: 未提取到任何字符</li>" >> $GITHUB_ENV
          fi

      # ---------- 子集化字体 ----------
      - name: 14. Subset fonts
        run: |
          for font in ./assets/fonts/fa-regular-400.woff2 \
                      ./assets/fonts/fa-brands-400.woff2 \
                      ./assets/fonts/fa-solid-900.woff2; do
            if [[ ! -f $font ]]; then
              echo "::warning::字体文件不存在: $font"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>Font missing: $font</li>" >> $GITHUB_ENV
              continue
            fi
            if ! pyftsubset "$font" \
                 --unicodes-file=./glyphhanger-chars.txt \
                 --flavor=woff2 \
                 --output-file="${font%.woff2}.subset.woff2"; then
              echo "::warning::字体子集化失败: $font"
              echo "WARN_COUNT=$(($WARN_COUNT+1))" >> $GITHUB_ENV
              echo "WARN_MSG=${WARN_MSG}<li>Font subset: $font</li>" >> $GITHUB_ENV
              continue
            fi
            mv "${font%.woff2}.subset.woff2" "$font"
          done

      # ---------- 预压缩 ----------
      - name: 15. Pre-compress static assets
        run: |
          find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.svg" -o -name "*.json" -o -name "*.html" -o -name "*.woff2" \) \
            -exec gzip -k -9 {} \;

      # ---------- 最终汇总 ----------
      - name: 16. Summary & decide exit code
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          if [[ $WARN_COUNT -eq 0 ]]; then
            echo "✅ 无警告，全部成功" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ 出现 <b>$WARN_COUNT</b> 个警告：" >> $GITHUB_STEP_SUMMARY
            echo "<ul>${WARN_MSG}</ul>" >> $GITHUB_STEP_SUMMARY
            if [[ "$FAIL_ON_WARNING" == "true" ]]; then
              echo "::error::因 FAIL_ON_WARNING=true，整流失败"
              exit 1
            fi
          fi

      # ---------- 部署 ----------
      - name: 17. Deploy to VPS 
        env:
          VPS_HOST:   ${{ secrets.VPS_HOST }}
          VPS_USER:   ${{ secrets.VPS_USER }}
          VPS_TARGET: ${{ secrets.VPS_TARGET_DIR }}
          VPS_KEY:    ${{ secrets.VPS_SSH_KEY }}
          BACKUP_DIR: /var/backups/site/$(date +%Y%m%d-%H%M%S)
        run: |
          install -m 700 -d ~/.ssh
          echo "$VPS_KEY" > ~/.ssh/ci_key
          chmod 600 ~/.ssh/ci_key
          ssh-keyscan -t ed25519 -p 22 "$VPS_HOST" 2>/dev/null > ~/.ssh/known_hosts

          ssh -i ~/.ssh/ci_key -o StrictHostKeyChecking=accept-new \
            "$VPS_USER@$VPS_HOST" \
            "mkdir -p $BACKUP_DIR && rsync -a --delete $VPS_TARGET/ $BACKUP_DIR/"

          rsync -rlzv --delete \
                --exclude='.git*' \
                --exclude='.user.ini' \
                --chmod=Dg+rwx,Fg+rw \
                -e 'ssh -i ~/.ssh/ci_key 2>/dev/null' \
                ./ "$VPS_USER@$VPS_HOST:$VPS_TARGET/"

          ssh -i ~/.ssh/ci_key "$VPS_USER@$VPS_HOST" \
            "sudo systemctl reload php-fpm nginx"

          if ! curl -sf https://yourdomain.com/health.txt >/dev/null; then
            echo "::error::站点返回非 200，开始回滚"
            ssh -i ~/.ssh/ci_key "$VPS_USER@$VPS_HOST" \
              "rsync -a --delete $BACKUP_DIR/ $VPS_TARGET/"
            exit 1
          fi
